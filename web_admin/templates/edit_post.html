{% extends "base.html" %}

{% block title %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å{% endblock %}
{% block page_title %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–∞{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-edit me-2"></i>
                    –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: "{{ post[1] }}"
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    <div class="mb-4">
                        <label for="title" class="form-label">
                            <i class="fas fa-heading me-1"></i>
                            –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ—Å—Ç–∞ *
                        </label>
                        <input type="text" class="form-control" id="title" name="title" 
                               value="{{ post[1] }}" required>
                    </div>
                    
                    <div class="mb-4">
                        <label for="content" class="form-label">
                            <i class="fas fa-align-left me-1"></i>
                            –¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞ *
                        </label>
                        <textarea class="form-control" id="content" name="content" rows="6" required>{{ post[2] }}</textarea>
                    </div>
                    
                    <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ—Å—Ç–∞ -->
                    <div class="mb-4">
                        <label class="form-label">
                            <i class="fas fa-image me-1"></i>
                            –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ—Å—Ç–∞
                        </label>
                        
                        <ul class="nav nav-tabs" id="imageTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="url-tab" data-bs-toggle="tab" 
                                        data-bs-target="#url-pane" type="button" role="tab">
                                    <i class="fas fa-link me-1"></i>URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="upload-tab" data-bs-toggle="tab" 
                                        data-bs-target="#upload-pane" type="button" role="tab">
                                    <i class="fas fa-upload me-1"></i>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª
                                </button>
                            </li>
                        </ul>
                        
                        <div class="tab-content border border-top-0 p-3">
                            <div class="tab-pane fade show active" id="url-pane" role="tabpanel">
                                <input type="url" class="form-control" id="image_url" name="image_url" 
                                       value="{{ post[11] if post|length > 11 else '' }}"
                                       placeholder="https://images.pexels.com/photos/..." 
                                       onchange="previewUrlImage(this)">
                            </div>
                            <div class="tab-pane fade" id="upload-pane" role="tabpanel">
                                <input type="file" class="form-control" id="image_file" name="image_file" 
                                       accept="image/*" onchange="previewUploadedImage(this)">
                            </div>
                        </div>
                        
                        <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
                        <div id="image-preview" class="mt-3" {% if not (post[11] if post|length > 11 else '') %}style="display: none;"{% endif %}>
                            <img id="preview-img" class="post-preview-image" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"
                                 {% if post|length > 11 and post[11] %}src="{{ post[11] }}"{% endif %}>
                        </div>
                    </div>
                    
                    <!-- –í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
                    <div class="mb-4">
                        <label class="form-label">
                            <i class="fas fa-clock me-1"></i>
                            –í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏
                        </label>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-sun text-warning fa-2x mb-2"></i>
                                        <h6>–£—Ç—Ä–æ–º</h6>
                                        <div class="form-check form-switch d-flex justify-content-center">
                                            <input class="form-check-input" type="checkbox" id="morning_enabled" 
                                                   name="morning_enabled" {{ 'checked' if post[3] }} 
                                                   onchange="toggleTimeSelection('morning')">
                                        </div>
                                        <select class="form-select form-select-sm mt-2" id="morning_time" name="morning_time" 
                                                {{ 'disabled' if not post[3] }}>
                                            <option value="07:00" {{ 'selected' if post[3] == '07:00' }}>07:00</option>
                                            <option value="08:00" {{ 'selected' if post[3] == '08:00' }}>08:00</option>
                                            <option value="09:00" {{ 'selected' if post[3] == '09:00' or not post[3] }}>09:00</option>
                                            <option value="10:00" {{ 'selected' if post[3] == '10:00' }}>10:00</option>
                                            <option value="11:00" {{ 'selected' if post[3] == '11:00' }}>11:00</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-sun text-info fa-2x mb-2"></i>
                                        <h6>–î–Ω–µ–º</h6>
                                        <div class="form-check form-switch d-flex justify-content-center">
                                            <input class="form-check-input" type="checkbox" id="afternoon_enabled" 
                                                   name="afternoon_enabled" {{ 'checked' if post[4] }}
                                                   onchange="toggleTimeSelection('afternoon')">
                                        </div>
                                        <select class="form-select form-select-sm mt-2" id="afternoon_time" name="afternoon_time"
                                                {{ 'disabled' if not post[4] }}>
                                            <option value="12:00" {{ 'selected' if post[4] == '12:00' }}>12:00</option>
                                            <option value="13:00" {{ 'selected' if post[4] == '13:00' }}>13:00</option>
                                            <option value="14:00" {{ 'selected' if post[4] == '14:00' or not post[4] }}>14:00</option>
                                            <option value="15:00" {{ 'selected' if post[4] == '15:00' }}>15:00</option>
                                            <option value="16:00" {{ 'selected' if post[4] == '16:00' }}>16:00</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-moon text-primary fa-2x mb-2"></i>
                                        <h6>–í–µ—á–µ—Ä–æ–º</h6>
                                        <div class="form-check form-switch d-flex justify-content-center">
                                            <input class="form-check-input" type="checkbox" id="evening_enabled" 
                                                   name="evening_enabled" {{ 'checked' if post[5] }}
                                                   onchange="toggleTimeSelection('evening')">
                                        </div>
                                        <select class="form-select form-select-sm mt-2" id="evening_time" name="evening_time"
                                                {{ 'disabled' if not post[5] }}>
                                            <option value="17:00" {{ 'selected' if post[5] == '17:00' }}>17:00</option>
                                            <option value="18:00" {{ 'selected' if post[5] == '18:00' }}>18:00</option>
                                            <option value="19:00" {{ 'selected' if post[5] == '19:00' or not post[5] }}>19:00</option>
                                            <option value="20:00" {{ 'selected' if post[5] == '20:00' }}>20:00</option>
                                            <option value="21:00" {{ 'selected' if post[5] == '21:00' }}>21:00</option>
                                            <option value="22:00" {{ 'selected' if post[5] == '22:00' }}>22:00</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="target_audience" class="form-label">
                            <i class="fas fa-users me-1"></i>
                            –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è
                        </label>
                        <select class="form-select" id="target_audience" name="target_audience">
                            <option value="channel" {{ 'selected' if post[6] == 'channel' }}>üì¢ –ö–∞–Ω–∞–ª (–ø—É–±–ª–∏—á–Ω–∞—è –ª–µ–Ω—Ç–∞)</option>
                            <option value="all" {{ 'selected' if post[6] == 'all' }}>üë• –í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã</option>
                            <option value="active" {{ 'selected' if post[6] == 'active' }}>üî• –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã</option>
                            <option value="vip" {{ 'selected' if post[6] == 'vip' }}>üíé VIP –∫–ª–∏–µ–Ω—Ç—ã</option>
                            <option value="new" {{ 'selected' if post[6] == 'new' }}>üÜï –ù–æ–≤—ã–µ –∫–ª–∏–µ–Ω—Ç—ã</option>
                        </select>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            <strong>–ö–∞–Ω–∞–ª:</strong> -1002566537425 (–ø—É–±–ª–∏—á–Ω—ã–µ –ø–æ—Å—Ç—ã)
                            <br><strong>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è:</strong> –∫–Ω–æ–ø–∫–∏ –∑–∞–∫–∞–∑–∞, —Å—Å—ã–ª–∫–∞ –Ω–∞ —Å–∞–π—Ç, –æ—Ç–∑—ã–≤—ã —Ç–æ–≤–∞—Ä–æ–≤
                        </div>
                    </div>
                    
                    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–Ω–æ–ø–æ–∫ -->
                    <div class="mb-4">
                        <label class="form-label">
                            <i class="fas fa-mouse-pointer me-1"></i>
                            –ö–Ω–æ–ø–∫–∏ –ø–æ–¥ –ø–æ—Å—Ç–æ–º
                        </label>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <label for="bot_username" class="form-label">Username –±–æ—Ç–∞</label>
                                <input type="text" class="form-control" id="bot_username" name="bot_username" 
                                       placeholder="Safar_call_bot" value="Safar_call_bot">
                            </div>
                            <div class="col-md-6">
                                <label for="website_url" class="form-label">–°—Å—ã–ª–∫–∞ –Ω–∞ —Å–∞–π—Ç</label>
                                <input type="url" class="form-control" id="website_url" name="website_url" 
                                       placeholder="https://your-website.com" value="https://your-website.com">
                            </div>
                        </div>
                        
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="include_reviews" name="include_reviews" checked>
                            <label class="form-check-label" for="include_reviews">
                                –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤—ã –æ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ç–æ–≤–∞—Ä–∞—Ö
                            </label>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save me-2"></i>
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                        </button>
                        <a href="{{ url_for('scheduled_posts') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>
                            –û—Ç–º–µ–Ω–∞
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-eye me-2"></i>
                    –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
                </h5>
            </div>
            <div class="card-body">
                <div class="border rounded p-3" style="background-color: #f8f9fa;">
                    <div id="preview-content">
                        <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
                    </div>
                </div>
                
                <div class="mt-3">
                    <h6>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏:</h6>
                    <div id="schedule-preview">
                        <!-- –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// –¢–µ –∂–µ —Ñ—É–Ω–∫—Ü–∏–∏ —á—Ç–æ –∏ –≤ create_post.html
function toggleTimeSelection(period) {
    const checkbox = document.getElementById(`${period}_enabled`);
    const select = document.getElementById(`${period}_time`);
    
    select.disabled = !checkbox.checked;
    updateSchedulePreview();
}

function previewUploadedImage(input) {
    const file = input.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('preview-img').src = e.target.result;
            document.getElementById('image-preview').style.display = 'block';
            updatePreview();
        };
        reader.readAsDataURL(file);
    }
}

function previewUrlImage(input) {
    const url = input.value;
    if (url) {
        document.getElementById('preview-img').src = url;
        document.getElementById('image-preview').style.display = 'block';
    } else {
        document.getElementById('image-preview').style.display = 'none';
    }
    updatePreview();
}

function updatePreview() {
    const title = document.getElementById('title').value;
    const content = document.getElementById('content').value;
    const imageUrl = document.getElementById('image_url').value || 
                    (document.getElementById('preview-img').src !== window.location.href ? 
                     document.getElementById('preview-img').src : '');
    const previewDiv = document.getElementById('preview-content');
    
    if (title || content || imageUrl) {
        let preview = '<div class="telegram-message">';
        
        if (imageUrl) {
            preview += `<img src="${imageUrl}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ—Å—Ç–∞" class="img-fluid rounded mb-2" style="max-height: 200px; width: 100%; object-fit: cover;">`;
        }
        
        if (title) {
            preview += `<div class="fw-bold mb-2">üì¢ <b>${title}</b></div>`;
        }
        if (content) {
            preview += `<div class="mb-2">${content.replace(/\n/g, '<br>')}</div>`;
        }
        preview += '<div class="mt-2 small text-muted">üõç –ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥: /start</div>';
        preview += '</div>';
        
        previewDiv.innerHTML = preview;
    } else {
        previewDiv.innerHTML = '<div class="text-muted text-center"><i class="fas fa-mobile-alt fa-2x mb-2"></i><p>–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞</p></div>';
    }
}

function updateSchedulePreview() {
    const scheduleDiv = document.getElementById('schedule-preview');
    let schedule = '';
    
    if (document.getElementById('morning_enabled').checked) {
        const time = document.getElementById('morning_time').value;
        schedule += `<div class="mb-1"><i class="fas fa-sun text-warning me-1"></i> –£—Ç—Ä–æ–º –≤ ${time}</div>`;
    }
    if (document.getElementById('afternoon_enabled').checked) {
        const time = document.getElementById('afternoon_time').value;
        schedule += `<div class="mb-1"><i class="fas fa-sun text-info me-1"></i> –î–Ω–µ–º –≤ ${time}</div>`;
    }
    if (document.getElementById('evening_enabled').checked) {
        const time = document.getElementById('evening_time').value;
        schedule += `<div class="mb-1"><i class="fas fa-moon text-primary me-1"></i> –í–µ—á–µ—Ä–æ–º –≤ ${time}</div>`;
    }
    
    if (schedule) {
        scheduleDiv.innerHTML = schedule;
    } else {
        scheduleDiv.innerHTML = '<small class="text-muted">–í–∫–ª—é—á–∏—Ç–µ –≤—Ä–µ–º—è –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞</small>';
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', function() {
    updatePreview();
    updateSchedulePreview();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
    document.getElementById('title').addEventListener('input', updatePreview);
    document.getElementById('content').addEventListener('input', updatePreview);
});
</script>

<style>
.telegram-message {
    background: white;
    border-radius: 12px;
    padding: 1rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
</style>
{% endblock %}