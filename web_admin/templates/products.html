
{% extends 'base.html' %}
{% block title %}Товары{% endblock %}
{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <h1 class="h3">Товары</h1>
  <a class="btn btn-primary" href="{{ url_for('add_product') }}">+ Добавить товар</a>
</div>

<form class="row gy-2 gx-2 align-items-end mb-3" method="get">
  <div class="col-md-3">
    <label class="form-label">Категория</label>
    <select class="form-select" name="category">
      <option value="">Все</option>
      {% for c in categories %}
        <option value="{{ c[0] }}" {% if category_filter and c[0]|string == category_filter %}selected{% endif %}>{{ c[1] }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-4">
    <label class="form-label">Поиск</label>
    <input class="form-control" name="search" value="{{ search or '' }}" placeholder="Название или описание...">
  </div>
  <div class="col-md-2">
    <label class="form-label">На страницу</label>
    <select class="form-select" name="per_page">
      {% for n in [10,20,30,50] %}
      <option value="{{n}}" {% if per_page==n %}selected{% endif %}>{{n}}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <button class="btn btn-dark w-100" type="submit">Применить</button>
  </div>
</form>

<div class="table-responsive">
<table class="table table-striped align-middle">
  <thead><tr>
    <th>ID</th><th>Фото</th><th>Название</th><th>Цена</th>
    <th>Остаток</th><th>Активен</th><th>Категория</th><th>Продаж</th><th>Просмотров</th><th>Действия</th>
  </tr></thead>
  <tbody>
  {% for p in products %}
  <tr>
    <td>{{ p[0] }}</td>
    <td>{% if p[8] %}<img src="{{ p[8] }}" alt="img" style="max-width: 60px; max-height: 60px; object-fit: cover; border-radius: 4px;">{% endif %}</td>
    <td>{{ p[1] }}</td>
    <td>${{ "%.2f"|format(p[2]) }}</td>
    <td>
      {% if p[3] == 0 %}
        <span class="badge bg-danger">Нет в наличии</span>
      {% elif p[3] <= 5 %}
        <span class="badge bg-warning">{{ p[3] }} шт.</span>
      {% else %}
        <span class="badge bg-success">{{ p[3] }} шт.</span>
      {% endif %}
    </td>
    <td>
      {% if p[4] %}
        <span class="badge bg-success">Да</span>
      {% else %}
        <span class="badge bg-secondary">Нет</span>
      {% endif %}
    </td>
    <td>{{ p[5] or '-' }}</td>
    <td>{{ p[6] or 0 }}</td>
    <td>{{ p[7] or 0 }}</td>
    <td>
      <div class="btn-group btn-group-sm">
        <a href="{{ url_for('edit_product', product_id=p[0]) }}" class="btn btn-outline-primary" title="Редактировать">
          <i class="fas fa-edit"></i>
        </a>
        <form method="post" action="{{ url_for('toggle_product', product_id=p[0]) }}" style="display:inline">
          <button class="btn btn-outline-warning" title="{% if p[4] %}Скрыть{% else %}Показать{% endif %}" type="submit">
            <i class="fas fa-{% if p[4] %}eye-slash{% else %}eye{% endif %}"></i>
          </button>
        </form>
        <form method="post" action="{{ url_for('delete_product', product_id=p[0]) }}" style="display:inline" onsubmit="return confirm('Удалить товар?')">
          <button class="btn btn-outline-danger" title="Удалить" type="submit">
            <i class="fas fa-trash"></i>
          </button>
        </form>
      </div>
    </td>
  </tr>
  {% endfor %}
  </tbody>
</table>
</div>

<nav aria-label="Pagination">
  <ul class="pagination">
    <li class="page-item {% if current_page<=1 %}disabled{% endif %}">
      <a class="page-link" href="?search={{search}}&category={{category_filter}}&per_page={{per_page}}&page={{ current_page-1 }}">Назад</a>
    </li>
    <li class="page-item disabled"><span class="page-link">{{ current_page }} / {{ total_pages }}</span></li>
    <li class="page-item {% if current_page>=total_pages %}disabled{% endif %}">
      <a class="page-link" href="?search={{search}}&category={{category_filter}}&per_page={{per_page}}&page={{ current_page+1 }}">Вперёд</a>
    </li>
  </ul>
</nav>
{% endblock %}
